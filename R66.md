# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

### Напишите список операций, которые вы будете производить для остановки запроса пользователя:

Получу запросы со врменем выполнения больше 180с:

```
db.currentOp({"secs_running":{$gt:180}})
```

Пример результата:

```
{
    "locks": {
      "^": "w",
      "^local": "W",
      "^myDB": "W"
    },
    "ns": "myDB.bar",
    "op": "update",
    "opid": 1344808,
    "query": {},
    "secs_running": 53,
    "waitingForLock": false
  }
```

После чего можно прервать выполнение запроса:

```
db.killOp(1344808)
```

### Предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB:

Предпологается, что с железом нет проблем, т.е. проблема либо в настройках либо в не оптимизированных запросах.
Можно включить профилирование:

```
[db.setProfilingLevel(level, options)](https://docs.mongodb.com/manual/reference/method/db.setProfilingLevel/#mongodb-method-db.setProfilingLevel)

```
К примеру, для поиска медленных запросов:

```
db.setProfilingLevel(1,100)
```

Обращаясь к db.system.profile найти проблемные запросы. 
Далее уже разбираться в чем причина используя [explain()](https://docs.mongodb.com/manual/tutorial/analyze-query-plan/)

## Задача 2 

### Решение:

Исходя из документации наиболее часто встречающаяся проблема - это проблема с памятью. Возможные варианты - это превышение объема выделенной оперативной памяти. 

## Задача 3 

### Решение:
 
Исходя из условия задачи, менялос только количество записей в таблицах. Т.е. можно не рассматривать варианты ошибок в запрах в виде не корректных связей (многие ко многим) между таблицами. Так как проблема возникает при выборке данных, то необходимо увеличить параметры отвечающие за timeout: connect_timeout, wait_timeout, interactive_timeout. Если это поможет, то проверить запросы. Определить по каким полям происходят связи между таблицами и какие поля используются в запросах, после проверить ниличие индексов. Возможно превышение размера буфера, необходимо проверить пераметр interactive_timeout.

## Задача 4

### Решение:

Проблема с доступной оперативной памятью Out Of Memory. Ядро операционной системы завершает процесс. Можно конечно отключить oom-kill 

```bash
sudo -s sysctl -w vm.oom-kill = 0
```

Но это не будет решением проблемы, а скорее усугубит происходящее. Можно проверить включена ли подкачка, если нет, то включить. Проверить на сколько используется swap. Возможно достаточно будет найти баланс между производительностью и доступных в настоящее время ресурсов перенеся swap после определения необходимого объема на более производительную дисковую подсистему или если такой возможности нет, то исходя из использования swap задуматься о выделении большего объема оперативной памяти.

